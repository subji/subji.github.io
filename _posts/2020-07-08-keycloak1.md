---
title: "MSA 인증 서비스 Keycloak 소개"
date: 2020-07-08
categories: posts
tags: ["msa", "keycloak"]
---

### **Keycloak 이란?**
---
Redhat 에서 개발한 서비스를 대상으로 하는 인증 & 권한 부여 오픈소스이다. 기반은 JBoss 와 WildFly 로 구성되어 있다. SSO, 소셜 로그인, LDAP, RDBMS 등의 User Federation 도 지원한다. 그 외에도 adapter, SPI, REST API 등을 제공한다.

기존에 OAuth 를 Spring Security 로 사용하려 했지만 oauth provider 쪽에서 예제가 많이 없어서 애를 먹었다. 그러다가 많은 예제들에서 나온것이 Keycloak 하고 Okta. 둘다 비슷한 인증 & 권한 부여 솔루션이지만 keycloak 이 더 많은 기능을 제공한다는 점에서 Keycloak 을 사용해 보려고 한다.

<br>

### **keycloak 설치 & 실행**
---
[Keycloak 다운로드](https://www.keycloak.org/downloads) 에 접속해서 ZIP or TAR.GZ 파일을 다운로드 받는다.

<div style="width: 100%; text-align: center;">
  <img src="https://subji.github.io/assets/images/keycloak1.png">
</div>

ZIP|TAR.GZ 를 받았으면 압축을 해제한다.

```sh
$ unzip keycloak-10.0.2.zip 

$ tar -zxvf keycloak-10.0.2.tar.gz
```

압축 해제가 끝나면 "bin" 디렉토리로 이동해서 "standalone.sh" 또는 "standalone.bat" 을 실행한다.

```sh
# For Linux/Unix
$ cd bin
$ sh standalone.sh # or ./standalone.sh

# For Windows
$ \bin\standalone.bat
```

이러면 실행은 끝났다. 아주 쉽다. 이제 브라우저를 열고 [http://localhost:8080/auth](http://localhost:8080/auth) 으로 접속하자.

<div style="width: 100%; text-align: center;">
  <img src="https://subji.github.io/assets/images/keycloak2.png">
</div>

관리자 콘솔 화면이 나온다. localhost 로 실행했을 경우 보안적인 이유로 인해 계정이 없는 상태로 실행된다. 만약 계정이 추가된 상태로 실행하고 싶으면 bin/add-user.sh or bin/add-user.bat 을 실행하자. 

<div style="width: 100%; text-align: center;">
  <img src="https://subji.github.io/assets/images/keycloak4.png">
</div>

위 화면에서 "Administration Console >" 을 선택하면 로그인 화면이 나온다. 그러면 이전에 가입한 관리자 이름과 비밀번호를 입력하자.

관리자 콘솔의 관리자 이름과 비밀번호를 입력하고 로그인을 하면 keycloak 관리자 화면이 나온다.

<div style="width: 100%; text-align: center;">
  <img src="https://subji.github.io/assets/images/keycloak3.png">
</div>

여기까지 오면 keycloak 실행까지는 끝난것이다.

<br>

## **Keycloak 관련 용어**
---
- **OIDC** : OAuth 가 권한 부여만 다루는 것이라면 OIDC 는 OAuth 를 포함하여 인증과 권한부여를 모두 포함한 것이다. SSO 의 구현을 위한 수단으로 사용된다. 
- **Realm** : 인증, 권한 부여가 적용되는 범위를 나타내는 단위이다. SSO 를 적용한다고 했을때 해당 SSO 가 적용되는 범위는 Realm 단위이다.
- **Client** : 인증, 권한 부여 행위를 대행하도록 맡길 어플리케이션을 나타내는 단위이다. 그 단위는 웹사이트 혹은 REST API 를 제공하는 서비스도 될 수 있다. 하나의 Realm 에 n개의 Client 를 생성, 관리할 수 있다.
- **User** : Client 에 인증을 요청할 사용자를 나타낸다. 하나의 Realm 에는 Realm 에 종속된 n개의 User 를 생성하고 관리할 수 있다. 기본적으로 User 는 *Username, Email, FirstName, LastName* 으로 구성되어 있지만 Custom User Attribute 를 사용하면 사용자가 원하는 속성을 추가할 수 있다.
- **Role** : User 에게 부여할 권한 내용을 나타낸다. 여기에는 Keycloak 의 REST API 를 사용할 권한을 부여할 수 있고 사용자가 정의한 권한을 부여할 수도 있다.

참고 : [https://jsonobject.tistory.com/445](https://jsonobject.tistory.com/445)